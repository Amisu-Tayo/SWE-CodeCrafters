<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard â€“ Fabric Inventory Management</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

  <!-- Prevent flash of protected content -->
  <style>body { visibility: hidden; }</style>
  <script>
    (async () => {
      try {
        const res = await fetch('/api/check_session', { credentials: 'include' });
        if (!res.ok) throw new Error();
        const { logged_in } = await res.json();
        if (!logged_in) throw new Error();
        document.body.style.visibility = 'visible';
      } catch {
        window.location.replace('/login.html');
      }
    })();
  </script>

  <style>
    /* ... your existing styles ... */
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg">
    <!-- ... navbar code ... -->
  </nav>

  <div class="container my-5">
    <!-- Summary Cards -->
    <div class="row g-4">
      <!-- Total Items (breakdown list) -->
      <div class="col-md-3">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title">Total Items</h5>
            <p id="total-items" class="card-text">Loading...</p>
          </div>
        </div>
      </div>

      <!-- Pending Orders -->
      <div class="col-md-3">
        <div class="card h-100 text-center">
          <div class="card-body">
            <h5 class="card-title">Pending Orders</h5>
            <p id="pending-orders" class="card-text">â€”</p>
          </div>
        </div>
      </div>

      <!-- Low Stock -->
      <div class="col-md-3">
        <div class="card h-100 text-center">
          <div class="card-body">
            <h5 class="card-title">Low Stock</h5>
            <p id="low-stock" class="card-text">â€”</p>
          </div>
        </div>
      </div>

      <!-- Monthly Usage -->
      <div class="col-md-3">
        <div class="card h-100 text-center">
          <div class="card-body">
            <h5 class="card-title">Monthly Usage</h5>
            <p id="monthly-usage" class="card-text">â€”</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Suggestions Panel -->
    <div class="mt-5">
      <h3>AI Suggestions</h3>
      <div id="suggestions" class="list-group"></div>
    </div>
  </div>

  <!-- FIMAI Chat Widget -->
  <!-- ... existing chat HTML ... -->

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <!-- Dashboard Script -->
  <script>
    document.getElementById('logoutButton').addEventListener('click', async () => {
      await fetch('/api/logout', { method: 'POST', credentials: 'include' });
      location.replace('/login.html');
    });

    (async () => {
      // 1) Fetch inventory
      const inv = await fetch('/api/inventory', { credentials: 'include' }).then(r => r.json());

      // Total Items breakdown
      const breakdown = inv.reduce((acc, item) => {
        const type = item.fabric_type;
        acc[type] = (acc[type] || 0) + item.quantity;
        return acc;
      }, {});
      const totalEl = document.getElementById('total-items');
      totalEl.innerHTML = Object.entries(breakdown)
        .map(([type, qty]) => `${type}: ${qty}`)
        .join('<br>');

      // 2) Pending Orders
      const orders = await fetch('/api/orders', { credentials: 'include' }).then(r => r.json());
      document.getElementById('pending-orders').innerText = orders.filter(o => o.status === 'Pending').length;

      // 3) Low Stock
      document.getElementById('low-stock').innerText = inv.filter(i => i.quantity < i.restock_threshold).length;

      // 4) Monthly Usage from sales (last 30 days removals)
      const usage = await fetch('/api/usage', { credentials: 'include' })
        .then(r => r.json())
        .then(d => d.monthly_usage);
      document.getElementById('monthly-usage').innerText = `${usage} yards`;

      // AI Suggestions
      const tips = await fetch(FIMAI_API_URL, { credentials: 'include' }).then(r => r.json());
      const container = document.getElementById('suggestions');
      tips.forEach(msg => {
        const el = document.createElement('div');
        el.className = 'list-group-item';
        el.innerText = `ðŸ¤– ${msg}`;
        container.appendChild(el);
      });
    })();

    // Chat JS...
  </script>
</body>
</html>
