<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard – Fabric Inventory Management</title>
  <link rel="stylesheet" href="/style.css" />

  <script>
  (async () => {
    // SESSION CHECK — this hits /api/check_session (and refreshes the Flask session expiry)
    try {
      const res = await fetch('/api/check_session', { credentials: 'include' });
      const { logged_in } = await res.json();
      if (!logged_in) throw new Error();
    } catch {
      return location.replace('/login.html');
    }

    // IDLE TIMEOUT (10 min)
    let idleTimer;
    const logoutNow = async () => {
      await fetch('/api/logout', { method: 'POST', credentials: 'include' });
      location.replace('/login.html');
    };
    const resetIdle = () => {
      clearTimeout(idleTimer);
      idleTimer = setTimeout(logoutNow, 10 * 60 * 1000);
    };
    ['load','mousemove','mousedown','click','scroll','keypress','touchstart']
      .forEach(evt => window.addEventListener(evt, resetIdle));
    resetIdle();
  })();
  </script>
</head>
<body>
  <div class="dashboard">
    <aside class="sidebar">
      <h2 class="logo">FIMS</h2>
      <nav>
        <ul>
          <li><a href="/inventory.html">Inventory</a></li>
          <li><a href="/orders.html">Orders</a></li>
          <li><a href="/reports.html">Reports</a></li>
        </ul>
        <button id="logoutButton">Logout</button>
      </nav>
    </aside>

    <main class="main">
      <header class="header"><h1>Dashboard</h1></header>
      <section class="cards">
        <div class="card"><h3>Total SKUs</h3><p id="total-skus">–</p></div>
        <div class="card"><h3>Total Value</h3><p id="total-value">–</p></div>
        <div class="card"><h3>Low Stock</h3><p id="low-stock">–</p></div>
        <div class="card"><h3>Pending Orders</h3><p id="pending-orders">–</p></div>
      </section>
    </main>
  </div>

  <script>
  // MANUAL LOGOUT
  document.getElementById('logoutButton').addEventListener('click', async () => {
    await fetch('/api/logout', { method: 'POST', credentials: 'include' });
    location.replace('/login.html');
  });

  // LOAD SUMMARY DATA
  (async () => {
    const inv = await fetch('/inventory', { credentials: 'include' }).then(r=>r.json());
    document.getElementById('total-skus').innerText = inv.length;
    const totalVal = inv.reduce((sum,i)=>sum + i.quantity * parseFloat(i.price_per_unit),0);
    document.getElementById('total-value').innerText = `$${totalVal.toFixed(2)}`;
    document.getElementById('low-stock').innerText = inv.filter(i=>i.quantity < i.restock_threshold).length;

    const orders = await fetch('/orders', { credentials: 'include' }).then(r=>r.json());
    document.getElementById('pending-orders').innerText = orders.filter(o=>o.status==='Pending').length;
  })();
  </script>
</body>
</html>